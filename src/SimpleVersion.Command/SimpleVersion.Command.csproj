<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <OutputType>Exe</OutputType>
    <TargetFramework>net462</TargetFramework>
    <RuntimeIdentifier>win-x64</RuntimeIdentifier>
    <AssemblyName>SimpleVersion</AssemblyName>    
  </PropertyGroup>

  <PropertyGroup Condition="'$(Configuration)' == 'Release'">
    <TrimUnusedDependencies>true</TrimUnusedDependencies>
    <!-- No pdbs for this project -->
    <DebugType>None</DebugType>
    <CopyOutputSymbolsToPublishDirectory>false</CopyOutputSymbolsToPublishDirectory>
    <!-- No pdbs from other projects -->
    <AllowedReferenceRelatedFileExtensions>none</AllowedReferenceRelatedFileExtensions>
  </PropertyGroup>

  <PropertyGroup Label="Publish/Pack Customizations">
    <!-- We pack custom assets after the publish task -->
    <IncludeContentInPack>false</IncludeContentInPack>
    <IncludeBuildOutput>false</IncludeBuildOutput>
    <GenerateNuspecDependsOn>$(GenerateNuspecDependsOn);_CustomPackFiles</GenerateNuspecDependsOn>
  </PropertyGroup>

  <ItemGroup>
    <!-- Support trimming - reduces size when self-contained -->
    <PackageReference Include="Microsoft.Packaging.Tools.Trimming" Version="1.1.0-*" />
    <!-- All references are private -->
    <PackageReference Update="@(PackageReference)" PrivateAssets="All" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\SimpleVersion.Git\SimpleVersion.Git.csproj" />
    <!-- All references are private -->
    <ProjectReference Update="@(ProjectReference)" PrivateAssets="All" />
  </ItemGroup>

  <!-- 
    Modify the actual publish output directory 
    as it is likely shared with other projects
  -->
  <Target Name="PrePublish" BeforeTargets="PrepareForPublish">
    <PropertyGroup>
      <PublishDir>$(PublishDir)\$(AssemblyName)</PublishDir>
    </PropertyGroup>
  </Target>
  
  <!--
    The application is published to a native exe
    We want to pack the native exe into the nuget package
    However, the native exe can only be built on publish,
    hence a post publish task.
  -->
  <Target Name="PostPublishPack" AfterTargets="Publish">
    <MSBuild 
      Projects="$(MSBuildProjectFullPath)" 
      Properties="NoBuild=true;Configuration=$(Configuration);PackageOutputPath=$(PublishDir);$(IncludeContentInPack)=false;PackageVersion=$(Version)$(VersionSuffix)" Targets="Pack" />
  </Target>

  <!-- 
    Pack the content that is published
  -->
  <Target Name="_CustomPackFiles">
    <ItemGroup>
      <_PackageFiles Include="$(PublishDir)\**\*" Exclude="$(PublishDir)\**\*.nupkg">
        <BuildAction>None</BuildAction>
        <PackagePath>tools\</PackagePath>
      </_PackageFiles>
    </ItemGroup>
  </Target>
</Project>
